\section{All tree comparisons}\label{sec:all-tree}


\parit{Proof of Theorem~\ref{thm:hilbert-quotient}.}
The ``if'' part follows from Exercise~\ref{ex:quotient};
let us prove the ``only if'' part.

Since $X$ is separable, it has a countable everywhere dense set $\{x_1,x_2,\dots\}$.
Consider the complete countable graph $K$ with the vertexes labeled by $x_1,x_2\dots$;
let $T\to K$ be its universal covering.

The graph $T$ is a tree with countable set of vertexes.
Note that $K$ can be presented as a union of a nested sequence of finite trees $T_1\subset T_2\subset \dots$;
moreover, we can assume that each $T_n$ is spanned by vertexes $\{y_1,\dots,y_n\}$ for some enumeration $y_1,y_2,\dots$ of the vertexes of $T$.
Denote by $s(y_i)$ the corresponding point $x_j$ in $X$.

Applying the tree comparison for each $T_n$ we get a finite configuration $\~y_{1,n},\dots,\~y_{n,n}$ in $\HH$.
Set $Y_n=\{\~y_{1,n},\dots,\~y_{n,n}\}$. 
Consider the map $s_n\:Y_n\to X$ defined by $s_n\:\~y_{i,n}\mapsto s(y_i)$.
By comparison, $s_n$ is a short map that preserves the distances between the points adjacent in $T_n$.

Without loss of generality, we may assume that for any $k\le n$, the points $\~y_{1,n},\dots,\~y_{k,n}$ lie in the subspace spanned by first $k-1$ elements of a fixed basis of $\HH$.
Passing to a partial limit as $n\to \infty$, we get a set $Y=\{\~y_1,\~y_2,\dots\}\subset \HH$ and a map $s\:Y\to X$ that is short and preserves the distances between the points adjacent in $T$.
In particular for any $\~y_i$ and $x_j$ there is $\~y_k$ such that $s(\~y_k)=x_j$ and $|\~y_i-\~y_k|_\HH=|s(\~y_i)-x_j|_X$.

By construction, the continuous extension of $s$ to the closure $\bar Y$ of $Y$ is a required submetry.
\qeds

The following proof was suggested by Alexander Lytchak, another proof follows from the construction of Chuu-Lian Terng and Gudlaugur Thorbergsson given in \cite[Section 4]{terng-thorbergsson}.


\parit{Proof of Proposition~\ref{prop:group}.}
Denote by $G^n$ the direct product of $n$ copies of $G$.
Consider the map $\phi_n\:G^n\to G/\!\!/H$ defined by
\[\phi_n\:(\alpha_1,\dots,\alpha_n)\mapsto [\alpha_1\cdots\alpha_n]_H,\]
where $[x]_H$ denotes the $H$-orbit of $x$ in $G$.

Note that $\phi_n$ is a quotient map for the action of $H\times G^{n-1}$ on $G^n$ defined by
\[(\beta_0,\dots,\beta_n)\cdot(\alpha_1,\dots,\alpha_n)=(\gamma_1\cdot \alpha_1\cdot\beta_1^{-1},\beta_1\cdot\alpha_2\cdot\beta_2^{-1},\dots,\beta_{n-1}\cdot\alpha_n\cdot\beta_n^{-1}),\]
where $\beta_i\in G$ and $(\beta_0,\beta_n)\in H<G\times G$.

Denote by $\rho_n$ the product metric on $G^n$ rescaled with factor $\sqrt{n}$.
Note that the quotient $(G^n,\rho_n)/(H\times G^{n-1})$ is isometric to $G/\!\!/H=(G,\rho_1)/\!\!/H$.
Let $\phi_n\:(G^n,\rho_n)\to G/\!\!/H$ be the corresponding quotient map; 
clearly $\phi_n$ is a submetry. 

As $n\to\infty$ the curvature of $(G^n,\rho_n)$ converges to zero and its injectivity radius goes to infinity.
Therefore the ultra-limit of $(G^n,\rho_n)$ with marked identity element is a Hilbert space $\HH$ and the submetries $\phi_n$ ultra-converge to a submetry $\phi\:\HH\to G/\!\!/H$.
It remains to apply Exercise~\ref{ex:quotient}.
\qeds
